# reverse usual HSMS passive and active role
# also exercises setting DEVID on commandline
#  starts both gemhost and gemsim
# uses tk send - start dmh_wish in foreground
# 
if {[string compare test [info procs test]] == 1} then {source defs}

global testdir gemsim_pid gemhost_pid gemsim gemhost

test passive-1 {start gemhost} {
  global testdir gemhost gemhost_pid
  set testdir [pwd]
  cd ../host
  set gemhost gemhost
  set gemhost_pid [exec gemhost "set PORT localhost:5577" "set HSMS 1" "set PASSIVE 1" "set DEVID 5" &]
  cd $testdir
  expr $gemhost_pid > 0
} 1

# use send to find gemhost
test passive-2 {send to gemhost} {
    global gemsim gemsim_pid
    wait 5000  ;# allow for init
    send $gemhost set gemhost(comm_state)
} {ENABLED {NOT COMMUNICATING}}
    

test passive-2 {start gemsim} {
    global testdir gemsim_pid gemsim    
    cd ../equip
    set gemsim gemsim
    set gemsim_pid [exec gemsim "set PORT 5577" "set DEVID 5" "set HOST localhost" "set PASSIVE 0" &]
    cd $testdir
    expr $gemsim_pid > 0 
} 1


# use send to chat with gemhost
test passive-4 {send to gemhost} {
    global gemhost gemhost_pid
    wait 10000  ;# allow for init
    send $gemhost set gemhost(comm_state)
} {COMMUNICATING}

# gemsim should also be talking
test passive-5 {send to gemsim} {
    global gemsim gemsim_pid
    send $gemsim set gemsim(comm_state)
} {COMMUNICATING}

# raise the main windows so any errors are visible
test passive-6 {send to gemsim} {
    global gemsim gemhost
    send $gemsim wm deiconify .
    send $gemhost wm deiconify .
} {}


test passive-7  {does gemsim reject unknown SnFm with S9} {
    global gemhost
    set cmd "secs_xact gemhost S3F17R {A {Carrier Received}}"
    set reply1 [send $gemhost $cmd]
    set cmd "secs_xact_failure gemhost"
    set reply2 [send $gemhost $cmd]
    list $reply1 $reply2
} {TIMEOUT REJECTED}

test passive-8 {gemsim should be in ON-LINE REMOTE mode} {
    global gemsim
    send $gemsim set gemsim(control_mode)
} {REMOTE}

test passive-9 {gemsim should perform recipe select RCMD} {
    global gemsim gemhost
    send $gemhost ei_rcmd gemhost PP-SELECT {{A PPExecName} {A brownies}}
} {0}

test passive-10 {gemsim should perform START RCMD} {
    global gemsim gemhost
    send $gemhost ei_rcmd gemhost START
} {0}

test passive-11 {put gemim in local control} {
    global gemsim gemhost
    send $gemsim set gemsim(control_mode) LOCAL
} {LOCAL}

test passive-12 {put gemim in local control} {
    global gemsim gemhost
    # call GUI action the way that the checkbox does
    send $gemsim eq_ui_control_mode gemsim
    send $gemsim set gemsim(control_state)
} {ON-LINE LOCAL}

test passive-13 {host sees event 4001 from control state change} {
    global gemsim gemhost
    wait 1000
    send $gemhost set gemhost(lastrmsg)
} {L:3 {U4:1 4001} {U4:1 4001} {L:0}}

test passive-14 {gemsim rejects process RCMD in local mode} {
    global gemsim gemhost
    wait 1000
    send $gemhost ei_rcmd gemhost STOP
} {2}

test passive-15 {put gemim in remote control} {
    global gemsim gemhost
    send $gemsim set gemsim(control_mode) REMOTE
} {REMOTE}

test passive-16 {put gemim in remote control} {
    global gemsim gemhost
    # call GUI action the way that the checkbox does
    send $gemsim eq_ui_control_mode gemsim
    send $gemsim set gemsim(control_state)
} {ON-LINE REMOTE}

test passive-17 {gemsim process RCMD} {
    global gemsim gemhost
    wait 1000
    send $gemhost ei_rcmd gemhost STOP
} {0}

test passive-18 {ask gemsim to go offline} {
    global gemsim gemhost
    send $gemhost secs_xact gemhost S1F15R
} {B:1 0x00}

wait 1000 ;# offline event then offline

test passive-18b {offline event} {
    global gemsim gemhost
    send $gemhost set gemhost(lastrSFR)
} {S6F13R}

test passive-19 {eq_when_offline} {
    global gemsim gemhost
    send $gemhost secs_xact gemhost S1F1R
} {TIMEOUT}

test passive-20a {eq_when_offline} {
    global gemsim gemhost
    send $gemhost set gemhost(lastrSFR)
} {S1F0}


test passive-21 {eq_when_offline} {
    global gemsim gemhost
    send $gemhost secs_xact gemhost S2F25R {B 1 2 3}
} {B:3 0x01 0x02 0x03}

test passive-22 {ask gemsim to go online} {
    global gemsim gemhost
    send $gemhost secs_xact gemhost S1F17R
} {B:1 0x00}

wait 1000 ;# expect online event

test passive-23 {online event} {
    global gemsim gemhost
    send $gemhost set gemhost(lastrSFR)
} {S6F13R}

test passive-24 {default gemsim clock} {
    global gemsim gemhost
    set reply [send $gemhost secs_xact gemhost S2F17R]
    # A:16 2000mmddhhmmsscc
    lindex $reply 0
} {A:16}

test passive-25 {change clock format} {
    global gemsim gemhost
    set reply [send $gemhost secs_xact gemhost S2F15R {L {L {U4 900} {U4 0}}}]
} {B:1 0x00}

test passive-26 {gemsim clock format 0} {
    global gemsim gemhost
    set reply [send $gemhost secs_xact gemhost S2F17R]
    # A:12 00mmddhhmmss
    lindex $reply 0
} {A:12}


test passive-27 {restore clock format} {
    global gemsim gemhost
    set reply [send $gemhost secs_xact gemhost S2F15R {L {L {U4 900} {U4 1}}}]
} {B:1 0x00}

test passive-28 {default gemsim clock} {
    global gemsim gemhost
    set reply [send $gemhost secs_xact gemhost S2F17R]
    # A:16 2000mmddhhmmsscc
    lindex $reply 0
} {A:16}


test passive-29 {eq has an alarm} {
    global gemsim gemhost
    set reply [send $gemsim SQL "update ei_alarm set is_set=1 where ALID='1000'"]
    string first "//c 0" $reply
} {1}

wait 1000

test passive-30 {host sees alarm and then event} {
    global gemsim gemhost
    set reply [send $gemhost SQL "select ALID from ei_alarm_log"]
    lindex $reply 4
} {1}

test passive-31 {host sees alarm and then event} {
    global gemsim gemhost
    set reply [send $gemhost set gemhost(lastrSFR)]
} {S6F13R}

test passive-32 {clear alarm} {
    global gemsim gemhost
    set reply [send $gemsim SQL "update ei_alarm set is_set=0 where ALID='1000'"]
    string first "//c 0" $reply
} {1}

wait 1000

test passive-33 {host sees alarm and then event} {
    global gemsim gemhost
    set reply [send $gemhost SQL "select ALID from ei_alarm_log where is_set=0"]
    lindex $reply 4
} {1}

test passive-34 {host sees alarm and then event} {
    global gemsim gemhost
    set reply [send $gemhost SQL "select CEID from ei_event_log where CEID='1000'"]
    lindex $reply 4
} {1}


test passive-35 {disable set/clear event reports} {
    global gemsim gemhost
    # empty alarm log
    send $gemhost SQL "delete from ei_alarm_log"
    # empty event log
    send $gemhost SQL "delete from ei_event_log"
    send $gemhost ei_event_disable gemhost {1000 1001}
} {0}

wait 1000

test passive-36 {eq has an alarm} {
    global gemsim gemhost
    set reply [send $gemsim SQL "update ei_alarm set is_set=1 where ALID='1000'"]
    string first "//c 0" $reply
} {1}

wait 1000

test passive-37 {host sees alarm and no event} {
    global gemsim gemhost
    set reply [send $gemhost SQL "select ALID from ei_alarm_log"]
    lindex $reply 4
} {1}

test passive-38 {host sees alarm and no event} {
    global gemsim gemhost
    set reply [send $gemhost SQL "select CEID from ei_event_log where CEID='1000'"]
    lindex $reply 4
} {0}

test passive-39 {disable alarm/clear report} {
    global gemsim gemhost
    send $gemhost ei_alarm_enable gemhost 0 {1000}
} {0}

wait 1000

test passive-40 {preclear alarm_log} {
    global gemsim gemhost
    # empty alarm log
    set reply [send $gemhost SQL "delete from ei_alarm_log"]
    string first "//c 0" $reply
} {1}

test passive-41 {clear alarm} {
    global gemsim gemhost
    set reply [send $gemsim SQL "update ei_alarm set is_set=0 where ALID='1000'"]
    string first "//c 0" $reply
} {1}

wait 1000

test passive-42 {host sees no alarm and no event} {
    global gemsim gemhost
    set reply [send $gemhost SQL "select ALID from ei_alarm_log"]
    lindex $reply 4
} {0}

test passive-43 {host sees no alarm and no event} {
    global gemsim gemhost
    set reply [send $gemhost SQL "select CEID from ei_event_log"]
    lindex $reply 4
} {0}

test passive-44 {eq has an alarm} {
    global gemsim gemhost
    set reply [send $gemsim SQL "update ei_alarm set is_set=1 where ALID='1000'"]
    string first "//c 0" $reply
} {1}

wait 1000

test passive-45 {host sees no alarm and no event} {
    global gemsim gemhost
    set reply [send $gemhost SQL "select ALID from ei_alarm_log"]
    lindex $reply 4
} {0}

test passive-46 {host sees no alarm and no event} {
    global gemsim gemhost
    set reply [send $gemhost SQL "select CEID from ei_event_log"]
    lindex $reply 4
} {0}



#################################################
# final shutdown
test passive-end {kill processes} {
    global gemsim gemhost
    send $gemsim "after 1 exit"
    send $gemhost "after 1 exit"
    expr 1
    } 1

