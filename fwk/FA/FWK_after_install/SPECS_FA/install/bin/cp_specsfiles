#!/usr/bin/ksh
trap "" 23

ECHO=print
if [ `uname -s` = "HP-UX" ]; then
    DLLSFX=".sl"
else
    DLLSFX=".so"
fi

VARTMP=/var/tmp
DEVNUL=/dev/null

DEST=/opt/SPECS
DESTFA=/opt/SPECS_FA
VARLOG=/var/opt/SPECS/log

DIRDMH=$DESTFA/dmh
DIRSRC=$DESTFA/SPECS
DIRSYS=$DEST/sys
DIRUSR=$DEST/usr

RECSFX=".rec"
SHLSFX=".sh"

FWKSFX=".fwk"
CFGSFX=".cf"
FASFX=".fa"
MSGSFX="~"

LIBSFX=".lib"
BASSFX=".bas"
SRCSFX="~"

usage()
{
    $ECHO "Usage: cp_specsfiles [-h] [-F] [-r|-f|-p|-u]"
    $ECHO "  Option:"
    $ECHO "    -h  - Display help"
    $ECHO "    -F  - Overwrite existing files"
    $ECHO "    -r  - Copy recipe files"
    $ECHO "    -f  - Copy framework files"
    $ECHO "    -p  - Copy prober algorithm librariey files (BASIC and C)"
    $ECHO "    -u  - Copy utility algorithm librariey files (BASIC and C)"
}

revsave_specsfiles()
{
    REVCMNT=$VARTMP/.comment

    if $DIRSYS/bin/revnum -A $2 -t $3 $1 > $DEVNUL; then
        $DIRSYS/bin/revopen -a $2 -t $3 $1
    else
        $ECHO "Revision: "$2 > $REVCMNT
        SPECS_REVCONT_ADMIN="TRUE" $DIRSYS/bin/revsave -a $2 -c $REVCMNT -t $3 $1
        rm $REVCMNT
    fi
}

copy_recipe_file()
{
    FILE=$1
    BASE=`basename $FILE`

    if [ $FORCE -eq 1 ]; then
        if [ $CP_BCK -eq 1 ]; then
            if [ -f $DIRUSR/$FILE$RECSFX ]; then
                rm -f $DIRUSR/$FILE$RECSFX.bak
                mv -f $DIRUSR/$FILE$RECSFX $DIRUSR/$FILE$RECSFX.bak
            fi
        else
            rm -f $DIRUSR/$FILE$RECSFX
        fi
    fi

    if [ ! -f $DIRUSR/$FILE$RECSFX ]; then
        cp -f $DIRSRC/recipe/src/$BASE$RECSFX $DIRUSR/$FILE$RECSFX
        chmod 444 $DIRUSR/$FILE$RECSFX
        chown root:sys $DIRUSR/$FILE$RECSFX
    fi
}

copy_recipe_shell()
{
    FILE=$1
    BASE=`basename $FILE`

    if [ $FORCE -eq 1 ]; then
        if [ $CP_BCK -eq 1 ]; then
            if [ -f $DIRUSR/$FILE$SHLSFX ]; then
                rm -f $DIRUSR/$FILE$SHLSFX.bak
                mv -f $DIRUSR/$FILE$SHLSFX $DIRUSR/$FILE$SHLSFX.bak
            fi
        else
            rm -f $DIRUSR/$FILE$SHLSFX
        fi
    fi

    if [ ! -f $DIRUSR/$FILE$SHLSFX ]; then
        cp -f $DIRSRC/recipe/bin/$BASE$SHLSFX $DIRUSR/$FILE$SHLSFX
        chmod 555 $DIRUSR/$FILE$SHLSFX
        chown root:sys $DIRUSR/$FILE$SHLSFX
    fi
}

copy_framework()
{
    FILE=$1
    DONE=0

    if [ -f $DIRSRC/$FILE$FWKSFX ]; then
        if [ $FORCE -eq 1 ]; then
            if [ $CP_BCK -eq 1 ]; then
                if [ -f $DIRUSR/$FILE$FWKSFX ]; then
                    rm -f $DIRUSR/$FILE$FWKSFX.bak
                    mv -f $DIRUSR/$FILE$FWKSFX $DIRUSR/$FILE$FWKSFX.bak
                fi
                if [ -f $DIRUSR/$FILE$CFGSFX ]; then
                    rm -f $DIRUSR/$FILE$CFGSFX.bak
                    mv -f $DIRUSR/$FILE$CFGSFX $DIRUSR/$FILE$CFGSFX.bak
                fi
                if [ -f $DIRUSR/$FILE$FASFX ]; then
                    rm -f $DIRUSR/$FILE$FASFX.bak
                    mv -f $DIRUSR/$FILE$FASFX $DIRUSR/$FILE$FASFX.bak
                fi
                if [ -d $DIRUSR/$FILE$MSGSFX ]; then
                    rm -fr $DIRUSR/$FILE$MSGSFX.bak
                    mv -f $DIRUSR/$FILE$MSGSFX $DIRUSR/$FILE$MSGSFX.bak
                fi
            else
                rm -f $DIRUSR/$FILE$FWKSFX
                rm -f $DIRUSR/$FILE$CFGSFX
                rm -f $DIRUSR/$FILE$FASFX
                rm -fr $DIRUSR/$FILE$MSGSFX
            fi
        fi

        if [ ! -f $DIRUSR/$FILE$FWKSFX ]; then
            DONE=1
            cp -f $DIRSRC/$FILE$FWKSFX $DIRUSR/$FILE$FWKSFX
            chmod 666 $DIRUSR/$FILE$FWKSFX
            chown root:sys $DIRUSR/$FILE$FWKSFX
        fi
        if [ ! -f $DIRUSR/$FILE$CFGSFX ]; then
            cp -f $DIRSRC/$FILE$CFGSFX $DIRUSR/$FILE$CFGSFX
            chmod 666 $DIRUSR/$FILE$CFGSFX
            chown root:sys $DIRUSR/$FILE$CFGSFX
        fi
        if [ ! -f $DIRUSR/$FILE$FASFX ]; then
            cp -f $DIRSRC/$FILE$FASFX $DIRUSR/$FILE$FASFX
            chmod 666 $DIRUSR/$FILE$FASFX
            chown root:sys $DIRUSR/$FILE$FASFX
        fi
        if [ ! -d $DIRUSR/$FILE$MSGSFX ]; then
            cp -fr $DIRSRC/$FILE$MSGSFX $DIRUSR/$FILE$MSGSFX
            for j in `find $DIRUSR/$FILE$MSGSFX -type d`; do
                chmod 777 $j
                chown root:sys $j
            done
            for j in `find $DIRUSR/$FILE$MSGSFX -type f`; do
                chmod 666 $j
                chown root:sys $j
            done
        fi

        if [ $DONE -eq 1 ]; then
            revsave_specsfiles "$DIRUSR/$FILE" "$REVNAME" "fwk"
        fi
    fi
}

copy_algorithm_basic()
{
    FILE=$1
    DONE=0

    if [ -f $DIRSRC/$FILE$LIBSFX ]; then
        if [ $FORCE -eq 1 ]; then
            if [ $CP_BCK -eq 1 ]; then
                if [ -f $DIRUSR/$FILE$LIBSFX ]; then
                    rm -f $DIRUSR/$FILE$LIBSFX.bak
                    mv -f $DIRUSR/$FILE$LIBSFX $DIRUSR/$FILE$LIBSFX.bak
                fi
                if [ -f $DIRUSR/$FILE$BASSFX ]; then
                    rm -f $DIRUSR/$FILE$BASSFX.bak
                    mv -f $DIRUSR/$FILE$BASSFX $DIRUSR/$FILE$BASSFX.bak
                fi
            else
                rm -f $DIRUSR/$FILE$LIBSFX
                rm -f $DIRUSR/$FILE$BASSFX
            fi
        fi

        if [ ! -f $DIRUSR/$FILE$LIBSFX ]; then
            DONE=1
            cp -f $DIRSRC/$FILE$LIBSFX $DIRUSR/$FILE$LIBSFX
            chmod 666 $DIRUSR/$FILE$LIBSFX
            chown root:sys $DIRUSR/$FILE$LIBSFX
        fi
        if [ ! -f $DIRUSR/$FILE$BASSFX ]; then
            cp -f $DIRSRC/$FILE$BASSFX $DIRUSR/$FILE$BASSFX
            chmod 666 $DIRUSR/$FILE$BASSFX
            chown root:sys $DIRUSR/$FILE$BASSFX
        fi

        if [ $DONE -eq 1 ]; then
            revsave_specsfiles "$DIRUSR/$FILE" "$REVNAME" "lib"
        fi
    fi
}

copy_algorithm_c()
{
    FILE=$1
    DONE=0

    if [ -f $DIRSRC/$FILE$LIBSFX ]; then
        if [ $FORCE -eq 1 ]; then
            if [ $CP_BCK -eq 1 ]; then
                if [ -f $DIRUSR/$FILE$LIBSFX ]; then
                    rm -f $DIRUSR/$FILE$LIBSFX.bak
                    mv -f $DIRUSR/$FILE$LIBSFX $DIRUSR/$FILE$LIBSFX.bak
                fi
                if [ -f $DIRUSR/$FILE$DLLSFX ]; then
                    rm -f $DIRUSR/$FILE$DLLSFX.bak
                    mv -f $DIRUSR/$FILE$DLLSFX $DIRUSR/$FILE$DLLSFX.bak
                fi
                if [ -d $DIRUSR/$FILE$SRCSFX ]; then
                    rm -fr $DIRUSR/$FILE$SRCSFX.bak
                    mv -f $DIRUSR/$FILE$SRCSFX $DIRUSR/$FILE$SRCSFX.bak
                fi
            else
                rm -f $DIRUSR/$FILE$LIBSFX
                rm -f $DIRUSR/$FILE$DLLSFX
                rm -fr $DIRUSR/$FILE$SRCSFX
            fi
        fi

        if [ ! -f $DIRUSR/$FILE$LIBSFX ]; then
            DONE=1
            cp -f $DIRSRC/$FILE$LIBSFX $DIRUSR/$FILE$LIBSFX
            chmod 666 $DIRUSR/$FILE$LIBSFX
            chown root:sys $DIRUSR/$FILE$LIBSFX
        fi
        if [ ! -f $DIRUSR/$FILE$DLLSFX ]; then
            cp -f $DIRSRC/$FILE$DLLSFX $DIRUSR/$FILE$DLLSFX
            chmod 777 $DIRUSR/$FILE$DLLSFX
            chown root:sys $DIRUSR/$FILE$DLLSFX
        fi
        if [ ! -d $DIRUSR/$FILE$SRCSFX ]; then
            cp -fr $DIRSRC/$FILE$SRCSFX $DIRUSR/$FILE$SRCSFX
            for j in `find $DIRUSR/$FILE$SRCSFX -type d`; do
                chmod 777 $j
                chown root:sys $j
            done
            for j in `find $DIRUSR/$FILE$SRCSFX -type f`; do
                chmod 666 $j
                chown root:sys $j
            done
        fi

        if [ $DONE -eq 1 ]; then
            revsave_specsfiles "$DIRUSR/$FILE" "$REVNAME" "lib"
        fi
    fi
}

IDSTR=`id -un`
if [ "$IDSTR" != "root" ]; then
    $ECHO "ERROR: You must log in as root."
    exit
fi

set -- `getopt hFrfpu $*`
if [ $? -ne 0 ]; then
    usage
    exit -1
fi

FORCE=0
CP_BCK=1
CP_ALL=1
CP_RCP=0
CP_FWK=0
CP_PRBLIB=0
CP_UTLLIB=0
while [ $# -gt 0 ]; do
    case $1 in 
    -h)
        usage
        exit 0
        ;;
    -F)
        FORCE=1
        shift 1
        ;;
    -r)
        CP_ALL=0
        CP_RCP=1
        shift 1
        ;;
    -f)
        CP_ALL=0
        CP_FWK=1
        shift 1
        ;;
    -p)
        CP_ALL=0
        CP_PRBLIB=1
        shift 1
        ;;
    -u)
        CP_ALL=0
        CP_UTLLIB=1
        shift 1
        ;;
    --)
        shift
        break
        ;;
    esac
done

if [ $# -ne 0 ]; then
    usage
    exit -1
fi

if [ $FORCE -eq 1 ]; then
    $ECHO "Backup user customized file?"
    print "Default = 'y'. [quit='q'] : \c"
    read CP_BCK

    if [ "$CP_BCK" = "q" ]; then
        exit 0
    elif [ "$CP_BCK" = "" ] || [ "$CP_BCK" = "y" ]; then
        CP_BCK=1
    elif [ "$CP_BCK" = "n" ]; then
        CP_BCK=0
    else
        $ECHO "ERROR: Unknown character '$CP_BCK'.  Customization canceled."
        exit -1
    fi
fi

if [ -d $DIRSRC/demo ]; then
    cp -p $DIRSRC/demo/* $DEST/demo
fi

if [ -f $DIRUSR/lib/libSecKeyCheck$DLLSFX ]; then
    rm -f $DIRUSR/lib/libSecKeyCheck$DLLSFX.bak
    mv -f $DIRUSR/lib/libSecKeyCheck$DLLSFX $DIRUSR/lib/libSecKeyCheck$DLLSFX.bak
fi
cp -f $DIRDMH/lib/libSecKeyCheck$DLLSFX $DIRUSR/lib/libSecKeyCheck$DLLSFX
chmod 755 $DIRUSR/lib/libSecKeyCheck$DLLSFX
chown root:sys $DIRUSR/lib/libSecKeyCheck$DLLSFX

if [ $CP_ALL -eq 1 ] || [ $CP_RCP -eq 1 ]; then
    copy_recipe_file tpl/FA_recipe
    copy_recipe_file tpl/FA_recipe2
    copy_recipe_file tpl/FA_condition

    copy_recipe_shell recipe/fa_recipe_q
    copy_recipe_shell recipe/fa_recipe_q2
    copy_recipe_shell recipe/fa_cond_q
fi

if [ $CP_ALL -eq 1 ] || [ $CP_FWK -eq 1 ]; then
    REVNAME=SPECS_FA_3.71
    copy_framework fwk/FA_TELP12
    copy_framework fwk/FA_TSKUF300
fi

if [ $CP_ALL -eq 1 ] || [ $CP_PRBLIB -eq 1 ]; then
    REVNAME=SPECS_FA_3.62
    copy_algorithm_basic alg/prober/TELP12_FACOM
    copy_algorithm_basic alg/prober/TSKUF300_FACOM
    REVNAME=SPECS_FA_3.63
    copy_algorithm_c calg/prober/TELP12_FACOM
    copy_algorithm_c calg/prober/TSKUF300_FACOM
fi

if [ $CP_ALL -eq 1 ] || [ $CP_UTLLIB -eq 1 ]; then
    REVNAME=SPECS_FA_3.62
    copy_algorithm_basic alg/utility/UTIL_FA
    REVNAME=SPECS_FA_3.62
    copy_algorithm_c calg/utility/UTIL_FA
fi
