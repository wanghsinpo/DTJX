#!/usr/bin/ksh
trap "" 23

ECHO=print

DEST=/opt/SPECS
FA_DEST=/opt/SPECS_FA

SYSBIN=$DEST/sys/bin
FA_SYSBIN=$FA_DEST/sys/lbin

export VGEM_TS_CLOCK=1
ENVCONF=$DEST/sys/config/envconf
SYSCONF=$DEST/sys/config/sysconf
FA_CONF=$FA_DEST/dmh/vgem/defaults.ini

TSCLOCK_CREATED="FALSE"
NTP_INIT_TIME_SYNC="-1"
NTP_INIT_TIME_SERVERS="0.rhel.pool.ntp.org 1.rhel.pool.ntp.org 2.rhel.pool.ntp.org 127.127.1.0"

tsclock_created()
{
    $ECHO "Do you want to use E148 (Network Time Synchronization)?"
    $ECHO "Type y (yes) or n (no), then press Return."
    $ECHO
    $ECHO "Default = 'n'. [quit='q'] : \c"
    read REPLY
    $ECHO

    if [ "$REPLY" = "q" ]; then
        exit
    elif [ "$REPLY" != "" ]; then
        if [ "$REPLY" = "n" ]; then
            return
        elif [ "$REPLY" = "y" ]; then
            TSCLOCK_CREATED="TRUE"
        else
            exit
        fi
    else
        return
    fi
}

ntp_init_time_sync()
{
    if [ "$TSCLOCK_CREATED" = "FALSE" ]; then
        NTP_INIT_TIME_SERVERS=""
        return
    fi

    $ECHO "Do you want to initialize network time synchronization"
    $ECHO "during VGEM startup?"
    $ECHO "Type y (yes) or n (no), then press Return."
    $ECHO
    $ECHO "Default = 'n'. [quit='q'] : \c"
    read REPLY
    $ECHO

    if [ "$REPLY" = "q" ]; then
        exit
    elif [ "$REPLY" != "" ]; then
        if [ "$REPLY" = "n" ]; then
            return
        elif [ "$REPLY" = "y" ]; then
            NTP_INIT_TIME_SYNC="0"
        else
            exit
        fi
    else
        return
    fi

    $ECHO "Do you want to enable network time synchronization"
    $ECHO "during VGEM startup?"
    $ECHO "Type y (yes) or n (no), then press Return."
    $ECHO
    $ECHO "Default = 'n'. [quit='q'] : \c"
    read REPLY
    $ECHO

    if [ "$REPLY" = "q" ]; then
        exit
    elif [ "$REPLY" != "" ]; then
        if [ "$REPLY" = "n" ]; then
            return
        elif [ "$REPLY" = "y" ]; then
            NTP_INIT_TIME_SYNC="1"
        else
            exit
        fi
    else
        return
    fi
}

ntp_init_time_servers()
{
    if [ "$NTP_INIT_TIME_SYNC" != "1" ]; then
        NTP_INIT_TIME_SERVERS=""
        return
    fi

    $ECHO "Enter list of IP addresses for network time synchronization."
    $ECHO
    $ECHO "Default = '$NTP_INIT_TIME_SERVERS'."
    $ECHO "[quit='q'] : \c"
    read REPLY
    $ECHO

    if [ "$REPLY" = "q" ]; then
        exit
    elif [ "$REPLY" != "" ]; then
        NTP_INIT_TIME_SERVERS="$REPLY"
    fi
}

update_ntp()
{
    tsclock_created
    ntp_init_time_sync
    ntp_init_time_servers

    if [ -f $FA_CONF ]; then
        FA_PARA="TSClockCreated"
        if ! grep -q $FA_PARA $FA_CONF; then
            $ECHO >> $FA_CONF
            $ECHO "# TRUE:  TS-Clock object is created in VGEM."     >> $FA_CONF
            $ECHO "# FALSE: TS-Clock object is not created in VGEM." >> $FA_CONF
            $ECHO "VGEM $FA_PARA FALSE"                              >> $FA_CONF
        fi
        sed -e "s/^VGEM $FA_PARA .*/VGEM $FA_PARA $TSCLOCK_CREATED/" $FA_CONF > $FA_CONF.tmp
        mv $FA_CONF.tmp $FA_CONF
        chmod 444 $FA_CONF
        chown root:sys $FA_CONF

        FA_PARA="NtpInitTimeSync"
        if ! grep -q $FA_PARA $FA_CONF; then
            $ECHO >> $FA_CONF
            $ECHO "# -1: Network time synchronization is not initialized during VGEM startup." >> $FA_CONF
            $ECHO "# 0:  Network time synchronization is disabled during VGEM startup."        >> $FA_CONF
            $ECHO "# 1:  Network time synchronization is enabled during VGEM startup."         >> $FA_CONF
            $ECHO "VGEM $FA_PARA -1"                                                           >> $FA_CONF
        fi
        sed -e "s/^VGEM $FA_PARA .*/VGEM $FA_PARA $NTP_INIT_TIME_SYNC/" $FA_CONF > $FA_CONF.tmp
        mv $FA_CONF.tmp $FA_CONF
        chmod 444 $FA_CONF
        chown root:sys $FA_CONF

        FA_PARA="NtpInitTimeServers"
        if ! grep -q $FA_PARA $FA_CONF; then
            $ECHO >> $FA_CONF
            $ECHO "# <IP Address>: List of IP addresses is specified for network time synchronization." >> $FA_CONF
            $ECHO "VGEM $FA_PARA \"\""                                                                  >> $FA_CONF
        fi
        sed -e "s/^VGEM $FA_PARA .*/VGEM $FA_PARA \"$NTP_INIT_TIME_SERVERS\"/" $FA_CONF > $FA_CONF.tmp
        mv $FA_CONF.tmp $FA_CONF
        chmod 444 $FA_CONF
        chown root:sys $FA_CONF
    fi
}

exec_ntp()
{
    if [ "$TSCLOCK_CREATED" = "FALSE" ]; then
        return
    fi

    OPT_TSCLK=""

    case $NTP_INIT_TIME_SYNC in
    "-1") return;;
    "0")  OPT_TSCLK="$OPT_TSCLK -d";;
    "1")  OPT_TSCLK="$OPT_TSCLK -e";;
    *)    exit;;
    esac

    for SERVER in $NTP_INIT_TIME_SERVERS; do
        OPT_TSCLK="$OPT_TSCLK -s $SERVER"
    done

    $FA_SYSBIN/tsclk $OPT_TSCLK
}

if [ `id -un` != "root" ]; then
    $ECHO "ERROR: You must log in as root."
    exit
fi

$ECHO
$ECHO "#### VGEM Network Time Synchronization Setup ####"

update_ntp
exec_ntp
