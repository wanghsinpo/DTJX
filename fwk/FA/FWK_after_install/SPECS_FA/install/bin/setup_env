#!/usr/bin/ksh
trap "" 23

ECHO=print
USRBIN=/usr/bin
SYSBIN=/opt/SPECS/sys/bin
VARLOG=/var/opt/SPECS/log
FAINST=/opt/SPECS_FA/install/bin
FAPROF=/opt/SPECS_FA/sys/resource/home/profile

DIRLIB=/usr/lib
DIRDMH=/opt/SPECS_FA/dmh/lib
DIRUSR=/opt/SPECS/usr/lib
DIRCALG=/opt/SPECS/usr/calg
DIRFAPT=/opt/SPECS_FA/fapt
DIRCOMCORE=$DIRFAPT/facomcore
if [ `uname -s` = "HP-UX" ]; then
    DLLSFX=".sl"
    LIBM="libm$DLLSFX"
    LIBTCL="libtcl8.3$DLLSFX"
    LIBTK="libtk8.3$DLLSFX"
    LIBCOMCORE="facomcore$DLLSFX"
    LIBCOMCSUB="FACOMCSUB$DLLSFX"

    RMB=/opt/rmb/bin/rmb
    RMBRC=/etc/opt/rmb/rmbrc
    if [ -x $SYSBIN/rmbrev ]; then
        RMB=/opt/rmb/rmb`$SYSBIN/rmbrev`/bin/rmb`$SYSBIN/rmbrev`
        RMBRC=/etc/opt/rmb/rmb`$SYSBIN/rmbrev`rc
    fi
else
    DLLSFX=".so"
    LIBM="libm$DLLSFX"
    LIBTCL="libtcl8.4$DLLSFX"
    LIBTK="libtk8.4$DLLSFX"
    LIBCOMCORE="facomcore$DLLSFX"
    LIBCOMCSUB="FACOMCSUB$DLLSFX"

    RMB=/opt/rmb/bin/rmb
    RMBRC=/etc/opt/rmb/rmbrc
fi

LIBSFX=".lib"
BASSFX=".bas"
SRCSFX="~"

ENVCONF=/opt/SPECS/sys/config/envconf
SYSCONF=/opt/SPECS/sys/config/sysconf
TMPLATE=/opt/SPECS/usr/etc/TEMPLATE.mak
ALGTYPE=`sed -n '/^ALGTYPE=\(.*\)$/s/^ALGTYPE=\(.*\)$/\1/p' $SYSCONF`

setup_envconf()
{
    if $USRBIN/grep -q $1 $ENVCONF; then
        $ECHO "        Already setting for $1 in system."
    else
        $ECHO "$1" >>$ENVCONF
    fi
}

setup_sysconf()
{
    if [ -z "$4" ]; then
        if $USRBIN/grep $1 $SYSCONF | $USRBIN/grep -q $2; then
            $ECHO "        Already $2 setting for $1 in system configuration file. Not modify."
        else
            $USRBIN/sed -e "s#^$1=\(.*\)\$#$1=\1\ $3$2#" $SYSCONF > $SYSCONF.tmp
            $USRBIN/mv $SYSCONF.tmp $SYSCONF
        fi
    elif [ $4 = "remove" ]; then
        while :; do
            if $USRBIN/grep $1 $SYSCONF | $USRBIN/grep -q $2; then
                $USRBIN/sed -e "s#^$1=\(.*\)$3\ *$2\ \(.*\)\$#$1=\1\2#" $SYSCONF > $SYSCONF.tmp
                if $USRBIN/diff $SYSCONF.tmp $SYSCONF >/dev/null; then
                    $USRBIN/mv $SYSCONF.tmp $SYSCONF
                    break
                fi
                $USRBIN/mv $SYSCONF.tmp $SYSCONF
            else
                break
            fi
        done
    fi
}

setup_template()
{
    if $USRBIN/grep $1 $TMPLATE | $USRBIN/grep -q $2; then
        $ECHO "        Already $2 setting for $1 in template file. Not modify."
    else
        if [ $1 = "USRLIBS" ]; then
            $USRBIN/sed -e "s#^$1=\(.*\)\$#$1=\1\ $2#" $TMPLATE > $TMPLATE.tmp
        elif [ $1 = "USRHDRS" ]; then
            $USRBIN/sed -e "s#^$1=\(.*\)\$#$1=\1\ -I$2#" $TMPLATE > $TMPLATE.tmp
        fi
        $USRBIN/mv $TMPLATE.tmp $TMPLATE
    fi
}

rebuild_algorithm()
{
    FILE=$1
    BLDLOG=$VARLOG/compilelog_`basename $FILE`.log

    rm -f $DIRCALG/$FILE$DLLSFX
    $SYSBIN/algmerge $DIRCALG/$FILE 2>&1 | tee $BLDLOG
    if [ -f $DIRCALG/$FILE$LIBSFX ]; then
        chmod 666 $DIRCALG/$FILE$LIBSFX
        chown root:sys $DIRCALG/$FILE$LIBSFX
    fi
    if [ -f $DIRCALG/$FILE$DLLSFX ]; then
        chmod 777 $DIRCALG/$FILE$DLLSFX
        chown root:sys $DIRCALG/$FILE$DLLSFX
    fi
    if [ -d $DIRCALG/$FILE$SRCSFX ]; then
        for j in `find $DIRCALG/$FILE$SRCSFX -type d`; do
            chmod 777 $j
            chown root:sys $j
        done
        for j in `find $DIRCALG/$FILE$SRCSFX -type f`; do
            chmod 666 $j
            chown root:sys $j
        done
        cd $DIRCALG/$FILE$SRCSFX
        make clobber
    fi

    rm -f $DIRCALG/$FILE$LIBSFX.org
    rm -f $DIRCALG/$FILE$DLLSFX.org
    rm -fr $DIRCALG/$FILE$SRCSFX.org
}

if [ `id -un` != "root" ]; then
    $ECHO "ERROR: You must log in as root."
    exit
fi

. $FAPROF

$ECHO "#### Setting envconf !! ####"
if [ -f $ENVCONF ]; then
    setup_envconf DMH_BIN
    setup_envconf SHLIB_PATH
    setup_envconf TCL_LIBRARY
    setup_envconf TK_LIBRARY
    setup_envconf DMH_LIBRARY
else
    cat $FAINST/envconf >$ENVCONF
fi

$ECHO "#### Setting sysconf !! ####"
if [ -f $SYSCONF ]; then
    setup_sysconf CUSRLIB $DIRLIB/$LIBM
    setup_sysconf CUSRLIB $DIRDMH/$LIBTCL
    setup_sysconf CUSRLIB $DIRDMH/$LIBTK
    setup_sysconf CUSRLIB $DIRUSR/$LIBCOMCORE

    if [ -x $RMB ]; then
        setup_sysconf RMBLIBS $DIRLIB "-S" "remove"
        setup_sysconf RMBLIBS $DIRDMH "-S"
        setup_sysconf RMBLIBS $DIRUSR "-S"
        setup_sysconf RMBLIBS $LIBM       "-s"
        setup_sysconf RMBLIBS $LIBTCL     "-s"
        setup_sysconf RMBLIBS $LIBTK      "-s"
        setup_sysconf RMBLIBS $LIBCOMCORE "-s"
        setup_sysconf RMBLIBS $LIBCOMCSUB "-s"

        if [ -f $RMBRC ]; then
            awk -f $FAINST/setup.awk $RMBRC >$RMBRC.tmp
            mv $RMBRC.tmp $RMBRC
        fi
    fi

    $FAINST/setup_framework
    $FAINST/setup_prober
    $FAINST/setup_tester
fi

$ECHO "#### Setting template !! ####"
if [ -f $TMPLATE ]; then
    setup_template USRHDRS $DIRCOMCORE
    setup_template USRLIBS $DIRLIB/$LIBM
    setup_template USRLIBS $DIRDMH/$LIBTCL
    setup_template USRLIBS $DIRDMH/$LIBTK
    setup_template USRLIBS $DIRUSR/$LIBCOMCORE
fi
# PRBLIB=`sed -n '/^PROBERLIB=\(.*\)$/s/^PROBERLIB=\(.*\)$/\1/p' $SYSCONF`
# rebuild_algorithm "$PRBLIB"
# UTLLIB=`sed -n '/^UTILLIB=\(.*\)$/s/^UTILLIB=\(.*\)$/\1/p' $SYSCONF`
# rebuild_algorithm "$UTLLIB"

$ECHO "#### Setting comm !! ####"
if [ -d /tmp/fapt ]; then
    $USRBIN/rm -fr /tmp/fapt
fi
$USRBIN/mkdir /tmp/fapt
$USRBIN/chown root:sys /tmp/fapt
$USRBIN/chmod 777 /tmp/fapt

cd $DIRCOMCORE
make clean
make all

if [ -x $RMB ] && [ "$ALGTYPE" = "BASIC" ]; then
    cd $DIRFAPT/FACOMCSUB
    make clean
    make all

    if [ -x $SYSBIN/BASIC.make ]; then
        $SYSBIN/BASIC.make
    fi
fi
