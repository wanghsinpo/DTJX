#!/usr/bin/sh
trap "" 23

typeset -i SHOW_SSMGR=0
SYSBIN="/opt/SPECS/sys/bin"
OS_NAME=`uname -s`
if [ "$OS_NAME" = "Linux" ]; then
    RHEL_REL=`/usr/bin/lsb_release -rs | sed 's/\..*//'`
    if [ $RHEL_REL -ge 7 ] ; then
        export XMODIFIERS=
    fi
fi

sync_proc()
{
    typeset -i count=0
    plist=$(ps -ef | grep startfa_shell | grep -v grep | awk '{print $2}')
    for pid in $plist; do
        count=$count+1
    done
    if test $count -gt 2; then
        exit 0
    fi

    typeset -i count=0
    while :; do
        plist=$(ps -ef | grep stopfa_shell | grep -v grep | awk '{print $2}')
        if [ x"$plist" == x ] ; then
            break
        elif test $count -eq 30; then
            exit -1
        fi
        count=$count+1
        sleep 1
    done
}

start_vgem()
{
    cd '/opt/SPECS_FA/dmh/startup'
    /usr/bin/sh -c './start_vgem 2>&1 1> /dev/null'&
}

start_specs()
{
    plist=$(ps -ef | grep exemon | grep -v grep | awk '{print $2}')
    if [ x"$plist" == x ] ; then
        id -gn > /tmp/gn
        if ipcs -mc | awk '{printf("%s %s\n", $5,$6)}' | grep root | grep -q -f /tmp/gn; then
            if [ -x $SYSBIN/stopsys ]; then
                stopsys
            fi
        fi
        rm -f /tmp/gn

        sleep 5
        if [ -x $SYSBIN/exemon ]; then
            exemon &
        fi
        sleep 5
    fi

    if test $SHOW_SSMGR -ne 0; then
        if [ -x $SYSBIN/ssmgr ]; then
            ssmgr &
        fi
    fi
}

sync_proc

start_vgem

start_specs
